# Pytoon V2 Docker Compose
# Ticket: P5-15
#
# Services:
#   - api:    FastAPI V2 API server
#   - worker: Background job worker (V1 + V2 pipelines)
#   - redis:  Job queue broker
#   - minio:  S3-compatible object storage (optional)
#
# Usage:
#   docker compose up -d                    # Start all services
#   docker compose up api worker            # API + Worker only
#   docker compose logs -f worker           # Watch worker logs
#
# External engine access:
#   Set RUNWAY_API_KEY, PIKA_API_KEY, LUMA_API_KEY in .env file.
#   Engine network egress is allowed by default.

version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    command: >
      uvicorn pytoon.api_orchestrator.app:app
      --host 0.0.0.0 --port 8000 --workers 2
    ports:
      - "8000:8000"
    volumes:
      - storage_data:/data/storage
      - ./config:/app/config:ro
    environment:
      - DATABASE_URL=sqlite:////data/storage/pytoon.db
      - REDIS_URL=redis://redis:6379/0
      - STORAGE_ROOT=/data/storage
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - RUNWAY_API_KEY=${RUNWAY_API_KEY:-}
      - PIKA_API_KEY=${PIKA_API_KEY:-}
      - LUMA_API_KEY=${LUMA_API_KEY:-}
    depends_on:
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: python -m pytoon.worker.main
    volumes:
      - storage_data:/data/storage
      - ./config:/app/config:ro
    environment:
      - DATABASE_URL=sqlite:////data/storage/pytoon.db
      - REDIS_URL=redis://redis:6379/0
      - STORAGE_ROOT=/data/storage
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - RUNWAY_API_KEY=${RUNWAY_API_KEY:-}
      - PIKA_API_KEY=${PIKA_API_KEY:-}
      - LUMA_API_KEY=${LUMA_API_KEY:-}
    depends_on:
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    environment:
      - MINIO_ROOT_USER=pytoon
      - MINIO_ROOT_PASSWORD=pytoon_secret
    restart: unless-stopped
    profiles:
      - full  # Only started with --profile full

volumes:
  storage_data:
  redis_data:
  minio_data:
