{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://pytoon.dev/schemas/scene_graph_v2.json",
  "title": "Pytoon V2 Scene Graph",
  "description": "Canonical Scene Graph schema for Pytoon V2. Defines the structured representation of each scene's content, media, style, overlays, and global audio. This is the authoritative contract between the Scene Planner and all downstream consumers (Timeline Orchestrator, Engine Manager, Audio/Caption Manager).",
  "version": "2.0",
  "type": "object",
  "required": ["version", "scenes"],
  "additionalProperties": false,
  "properties": {
    "version": {
      "type": "string",
      "const": "2.0",
      "description": "Schema version. Must be '2.0' for V2 scene graphs."
    },
    "scenes": {
      "type": "array",
      "minItems": 1,
      "description": "Ordered list of scene nodes. At least one scene is required.",
      "items": {
        "$ref": "#/definitions/Scene"
      }
    },
    "globalAudio": {
      "$ref": "#/definitions/GlobalAudio",
      "description": "Global audio configuration: voice script, voice file, and background music."
    }
  },
  "definitions": {
    "Scene": {
      "type": "object",
      "required": ["id", "description", "duration", "media", "caption"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1,
          "description": "Unique scene identifier. Must be unique within the scene graph."
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of the scene's purpose and content."
        },
        "duration": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 60000,
          "description": "Scene duration in milliseconds. Minimum 1000ms (1s), maximum 60000ms (60s)."
        },
        "media": {
          "$ref": "#/definitions/SceneMedia",
          "description": "Primary media content for this scene."
        },
        "caption": {
          "type": "string",
          "description": "On-screen caption text for this scene. Empty string if no caption."
        },
        "audio": {
          "type": ["string", "null"],
          "default": null,
          "description": "Per-scene audio file reference, or null to use global audio."
        },
        "style": {
          "$ref": "#/definitions/SceneStyle",
          "description": "Visual style metadata for this scene."
        },
        "overlays": {
          "type": "array",
          "default": [],
          "description": "Overlay elements rendered on top of the primary media (product images, logos, etc.).",
          "items": {
            "$ref": "#/definitions/SceneOverlay"
          }
        },
        "transition": {
          "type": "string",
          "enum": ["cut", "fade", "fade_black", "swipe_left", "swipe_right"],
          "default": "fade",
          "description": "Transition type to the NEXT scene. The last scene's transition is ignored."
        }
      }
    },
    "SceneMedia": {
      "type": "object",
      "required": ["type"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["image", "video"],
          "description": "'image' for static assets (product images) rendered with effects. 'video' for scenes requiring AI-generated or pre-existing video content."
        },
        "asset": {
          "type": ["string", "null"],
          "default": null,
          "description": "File path or URI to the media asset. Null if the asset will be generated by an engine."
        },
        "engine": {
          "type": ["string", "null"],
          "enum": ["runway", "pika", "luma", "local", null],
          "default": null,
          "description": "Engine identifier for generating this scene's video content. Null for image-type scenes or when engine selection is deferred to the Engine Manager."
        },
        "prompt": {
          "type": ["string", "null"],
          "default": null,
          "description": "Text prompt for AI video generation. Required when engine is set. Null for image-type scenes."
        },
        "effect": {
          "type": ["string", "null"],
          "enum": ["ken_burns_zoom", "ken_burns_pan", "slow_zoom_in", "slow_zoom_out", "static", null],
          "default": null,
          "description": "Visual effect applied to the media. Primarily used for image-type scenes."
        }
      }
    },
    "SceneStyle": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "mood": {
          "type": ["string", "null"],
          "default": null,
          "description": "Mood keyword for this scene (e.g., 'cinematic', 'upbeat', 'dramatic', 'warm', 'cool')."
        },
        "camera_motion": {
          "type": ["string", "null"],
          "default": null,
          "description": "Camera motion directive (e.g., 'slow dolly in', 'static', 'pan left', 'orbit')."
        },
        "lighting": {
          "type": ["string", "null"],
          "default": null,
          "description": "Lighting directive (e.g., 'warm golden hour', 'neon', 'studio', 'natural')."
        }
      }
    },
    "SceneOverlay": {
      "type": "object",
      "required": ["type", "asset"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "enum": ["product_image", "logo", "text", "graphic"],
          "description": "Type of overlay element."
        },
        "asset": {
          "type": "string",
          "description": "File path or URI to the overlay asset."
        },
        "position": {
          "type": "string",
          "enum": ["center", "top-left", "top-right", "bottom-left", "bottom-right", "custom"],
          "default": "center",
          "description": "Overlay position on the frame."
        },
        "scale": {
          "type": "number",
          "minimum": 0.01,
          "maximum": 2.0,
          "default": 1.0,
          "description": "Scale factor for the overlay (1.0 = original size)."
        },
        "opacity": {
          "type": "number",
          "minimum": 0.0,
          "maximum": 1.0,
          "default": 1.0,
          "description": "Opacity of the overlay (0.0 = fully transparent, 1.0 = fully opaque)."
        }
      }
    },
    "GlobalAudio": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "voiceScript": {
          "type": ["string", "null"],
          "default": null,
          "description": "Full narration script text. Used for TTS generation if no voiceFile is provided."
        },
        "voiceFile": {
          "type": ["string", "null"],
          "default": null,
          "description": "File path or URI to a user-provided voiceover audio file (WAV, MP3, AAC)."
        },
        "backgroundMusic": {
          "type": ["string", "null"],
          "default": null,
          "description": "File path or URI to background music track."
        }
      }
    }
  },
  "x-validation-rules": {
    "scene_ids_unique": "All scene 'id' values must be unique within the scenes array.",
    "duration_sum_max": "Sum of all scene 'duration' values must not exceed 60000ms (60 seconds).",
    "min_one_scene": "The 'scenes' array must contain at least one scene.",
    "engine_requires_prompt": "If media.engine is set (not null), media.prompt must also be set (not null).",
    "video_type_needs_engine_or_asset": "If media.type is 'video', either media.engine or media.asset must be set."
  }
}
